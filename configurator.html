<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Welcome to ACME eCommerce website</title>
		<link rel="stylesheet" type="text/css" href="configurator.css">
	</head>
<body>
	
<!--THREE JS-->	
	<!--Librerie da importare-->
	<script src="lib/three.js"></script>
	<script src="lib/OrbitControls.js"></script>
	<script src="lib/stats.js"></script>
	<script src="lib/OBJLoader.js"></script>
	<script src="lib/dat.gui.min.js"></script>
	
	<!--Vertex Shader-->
	<script type="text/x-glsl" id="vertex">
		varying vec3 vNormal;
		varying vec3 vPosition;
		varying vec2 uVv;

		void main() {
			vec4 vPos = modelViewMatrix * vec4( position, 1.0 );
			vPosition = vPos.xyz;
			vNormal = normalMatrix * normal;
			uVv = uv;
			gl_Position = projectionMatrix * vPos;
		}
	</script>

	<!--Fragment Shader-->
	<script type="text/x-glsl" id="fragment">
		varying vec3 vNormal;
		varying vec3 vPosition;
		varying vec2 uVv;
		uniform vec3 pointLightPosition; // in world space
		uniform vec3 clight;
		uniform vec3 ambientLight;
		uniform vec3 cspec;
		uniform vec3 cdiff;
		uniform float roughness;
		uniform sampler2D normalMap;
		uniform sampler2D aoMap;
		uniform vec2 normalScale;
		const float PI = 3.14159;
		#extension GL_OES_standard_derivatives : enable
			
		vec3 FSchlick(float lDoth) {
			return (cspec + (vec3(1.0)-cspec)*pow(1.0 - lDoth,5.0));
		}

		float DGGX(float nDoth, float alpha) {
			float alpha2 = alpha*alpha;
			float d = nDoth*nDoth*(alpha2-1.0)+1.0;
			return (  alpha2 / (PI*d*d));
		}
			
		float G1(float dotProduct, float k) {
			return (dotProduct / (dotProduct*(1.0-k) + k) );	
		}
			
		float GSmith(float nDotv, float nDotl) {
			float k = roughness*roughness;
			return G1(nDotl,k)*G1(nDotv,k);
		}
			
		
		
		vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {
			vec3 q0 = dFdx( eye_pos.xyz );
			vec3 q1 = dFdy( eye_pos.xyz );
			vec2 st0 = dFdx( uVv.st );
			vec2 st1 = dFdy( uVv.st );
			vec3 S = normalize(  q0 * st1.t - q1 * st0.t );
			vec3 T = normalize( -q0 * st1.s + q1 * st0.s );
			vec3 N =  surf_norm ;
			vec3 mapN = normalize(texture2D( normalMap, uVv ).xyz * 2.0 - 1.0);
			mapN.xy = normalScale * mapN.xy;
			mat3 tsn = mat3( S, T, N );
			return normalize( tsn * mapN );
		}

		void main() {
			vec4 lPosition = viewMatrix * vec4( pointLightPosition, 1.0 );
			vec3 l = normalize(lPosition.xyz - vPosition.xyz);
			vec3 n = perturbNormal2Arb( vPosition, normalize( vNormal ));
			vec3 v = normalize( -vPosition);
			vec3 h = normalize( v + l);

			// small quantity to prevent divisions by 0
			float nDotl = max(dot( n, l ),0.000001);
			float lDoth = max(dot( l, h ),0.000001);
			float nDoth = max(dot( n, h ),0.000001);
			float vDoth = max(dot( v, h ),0.000001);
			float nDotv = max(dot( n, v ),0.000001);
			vec3 fresnel = FSchlick(lDoth);

			vec3 BRDF = (vec3(1.0)-fresnel)*cdiff/PI + fresnel*GSmith(nDotv,nDotl)*DGGX(nDoth,roughness*roughness)/
					(4.0*nDotl*nDotv);

			vec3 outRadiance = PI* clight * nDotl * BRDF + ambientLight*cdiff*texture2D( aoMap, uVv ).xyz;
			
			// gamma encode the final value
			gl_FragColor = vec4(pow( outRadiance, vec3(1.0/2.2)), 1.0);
			}
		</script>


	<!--Threejs code-->
	<div id="threejs">
	<script>
		
		var renderer = new THREE.WebGLRenderer({antialias: true});
		var camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 1, 1000);
		var controls = new THREE.OrbitControls( camera, renderer.domElement); //Controlli sulla camera
		var scene = new THREE.Scene();
		camera.position.set(0,100,200);

		//Luce puntiforme bianca
		var lightParameters = {
			red: 1.0,
			green: 1.0,
			blue: 1.0,
			intensity: 1.0
		}
		
		var ambientLightParameters = {
			red: 1.0,
			green: 1.0,
			blue: 1.0,
			intensity: 1.0
		}
		
		var textureParameters = {
			normalScale: 0.0
		}

		var normalMap = loadTexture("texture/Aluminum_normal.png");
		var aoMap = loadTexture("texture/Aluminum_Diffuse.png");

		//Passo gli uniforms agli shader
		var uniforms = {
			cspec: { type: "v3", value: new THREE.Vector3(0.04,0.04,0.04)},
			cdiff: { type: "v3", value: new THREE.Vector3(0.8,0.8,0.8)},
			roughness: {type: "f", value: 0.2},
			normalMap: {type: "t", value: normalMap},
			aoMap: {type: "t", value: aoMap},
			normalScale: {type: "v2", value: new THREE.Vector2(1,1)},
			pointLightPosition: {type: "v3", value: new THREE.Vector3()},
			clight: {type: "v3", value: new THREE.Vector3()},
			ambientLight: {type: "v3", value: new THREE.Vector3()}
		};
		
		//Assi cartesiani
		var axesHelper = new THREE.AxesHelper( 1000);
		scene.add( axesHelper );
		
		//Carico gli shader
		vs = document.getElementById("vertex").textContent;
		fs = document.getElementById("fragment").textContent;
		
		//Materiale da shader
		var myMaterial = new THREE.RawShaderMaterial({uniforms: uniforms, vertexShader: vs, fragmentShader: fs});
		
		//Caricatore modello
		var loader = new THREE.OBJLoader();
		//Carico il modello da source
		loader.load(
			'model/pixar_lamp.obj',
			function ( group ) {
				geometry = group.children[0].geometry;
				geometry.center();
				mesh = new THREE.Mesh( geometry, myMaterial );
				mesh.scale.multiplyScalar(0.1);
				scene.add( mesh );
				
		});
	
		//Luce puntiforme
		var lightMesh = new THREE.Mesh(new THREE.SphereGeometry(1,16,16), new THREE.MeshBasicMaterial({color: 0xffff00, wireframe: true}));
		lightMesh.position.set(200, 200, 200);
		uniforms.pointLightPosition.value = new THREE.Vector3(lightMesh.position.x, lightMesh.position.y, lightMesh.position.z);
		
		//Carico la Cube Map
		var loader = new THREE.CubeTextureLoader();
		loader.setPath('envMap/');

		var textureCube = loader.load([
			'posx.jpg', 'negx.jpg',
			'posy.jpg', 'negy.jpg',
			'posz.jpg', 'negz.jpg'
		]);
		textureCube.format = THREE.RGBFormat;
		textureCube.mapping = THREE.CubeReflectionMapping;
		
		/*Sfera di prova
		var texture = new THREE.TextureLoader().load('texture/Bamboo_Diffuse.png');
		texture.wrapS = THREE.RepeatWrapping;
		texture.wrapT = THREE.RepeatWrapping;
		texture.repeat.set( 4, 4 );
		var geometry = new THREE.SphereGeometry(50, 60, 60);
		var material = new THREE.MeshBasicMaterial({map: texture});
		var sphere = new THREE.Mesh(geometry, material);
		scene.add(sphere);
		*/

		
		//Interfaccia per modifiche runtime
		var gui;
		//Statistiche sul frame rate
		var stats = new Stats();
		
		//Carico texture
		function loadTexture(file) {
			var texture = new THREE.TextureLoader().load( file, function (texture) {
				
				texture.minFilter = THREE.LinearMipMapLinearFilter;
				texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
				texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
				texture.offset.set(0,0);
				texture.needsUpdate = true;
				render();
			})
			return texture;
		}

		function init() {
			
			renderer.setClearColor( 0xf0f0f0 );
			
			scene.add(camera);
			scene.add(lightMesh);
			
			document.body.appendChild(renderer.domElement);
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			
			controls.addEventListener('change', render);
			controls.update();
			
			window.addEventListener('resize', onResize, false);
			
			//Statistiche sul Frame Rate
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild(stats.domElement);
			
			//myMaterial.needsUpdate = true;
			
		}
		
		function onResize() {
			
			renderer.setSize(window.innerWidth, window.innerHeight);
			camera.aspect = (window.innerWidth / window.innerHeight);
			camera.updateProjectionMatrix();
		}
		
		function update() {
			requestAnimationFrame( update );
			stats.update();
		}


		function render() {
			updateUniforms();
			renderer.render(scene, camera);

			//Debugging
			console.log();

		}
		
		function clearGui() {
			
			if ( gui ) gui.destroy();
			gui = new dat.GUI();
			gui.open();
		}
		
		
		function buildGui() {
				clearGui();
				lightSettings = gui.addFolder('Light Parameters');
				lightSettings.add(lightParameters,'red').min(0).max(1).onChange( function(newVal) { render() });
				lightSettings.add(lightParameters,'green').min(0).max(1).onChange( function(newVal) { render() });
				lightSettings.add(lightParameters,'blue').min(0).max(1).onChange( function(newVal) { render() });
				lightSettings.add(lightParameters,'intensity').min(0).max(10000).onChange( function(newVal) { render() });
				ambientLightSettings = gui.addFolder('Ambient Light Parameters');
				ambientLightSettings.add(ambientLightParameters,'red').min(0).max(1).onChange( function(newVal) { render() });
				ambientLightSettings.add(ambientLightParameters,'green').min(0).max(1).onChange( function(newVal) { render() });
				ambientLightSettings.add(ambientLightParameters,'blue').min(0).max(1).onChange( function(newVal) { render() });
				ambientLightSettings.add(ambientLightParameters,'intensity').min(0).max(100).onChange( function(newVal) { render() });
				textureSettings = gui.addFolder('Texture parameters');
				textureSettings.add(textureParameters,'normalScale').min(-3).max(3).onChange( function( newVal ) {render()});
				}
			function updateUniforms() {
					uniforms.clight.value = new THREE.Vector3(
							lightParameters.red * lightParameters.intensity,
					    lightParameters.green * lightParameters.intensity,
							lightParameters.blue * lightParameters.intensity);
					uniforms.ambientLight.value = new THREE.Vector3(
							ambientLightParameters.red * ambientLightParameters.intensity,
							ambientLightParameters.green * ambientLightParameters.intensity,
							ambientLightParameters.blue * ambientLightParameters.intensity);
					uniforms.normalScale.value = new THREE.Vector2( textureParameters.normalScale, textureParameters.normalScale );
			}
		
		
		init();
		buildGui();
		update();
		render();
		

    </script>
	</div>

		
<!--Web Site-->

	<!--header class="site-header">
		<h1 id="site-title"><span><a href="<?php echo esc_url( home_url( '/' ) ); ?>" title="<?php echo esc_attr( get_bloginfo( 'name', 'display' ) ); ?>" target="_top" rel="home">
			<img src="logo/ACME.jpg" alt="Acme Inc." width="500" height="95" class="logo" /></a></span></h1>
  		<nav>
    		<ul>
			  <li><a href="#" class="bounceInDown animated">Home</a></li>
			  <li><a href="#" class="bounceInDown animated">Chi siamo</a></li>
			  <li><a href="#" class="bounceInDown animated">News</a></li>
			  <li><a href="#" class="bounceInDown animated">Store</a></li>
			  <li><a href="#" class="bounceInDown animated">Contatti</a></li>
			</ul>
  		</nav>
	</header>
	<div class="contenitore">
  		<div class="card">
    		<div class="card-body">
      			<div class="descrizione-prodotto"> 
					<span class="prodotto"><b>Pixar Lamp</b><span class="badge">New</span></span>
					<span class="categoria"><b>Ufficio e studio</b></span> 
					<span class="info">L'originale Pixar Lamp. Illumina i tuoi sogni</span> 
				</div>
      			<div class="configuratore"> 
					<span class="quantita">
        				<h4>Quantità</h4>
						<ul class="ul-quantita">
						  <li><a href="#">1</a></li>
						  <li><a href="#">2</a></li>
						  <li><a href="#">4</a></li>
						</ul>
						</span> 
					<span class="materiali-prodotto"><h4>Materiale</h4>
						<ul class="ul-materiali">
						  <li><a href="#" class="plastic-orange animated pulse"></a></li>
						  <li><a href="#" class="midnight-black"></a></li>
						  <li><a href="#" class="original-aluminium"></a></li>
						</ul>
						</span> 
					<span class="prezzo"> € <b>29,98</b> </span> 
				</div>
    		</div>
  		</div>
	</div>-->

</body>
</html>
