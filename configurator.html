<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Welcome to ACME eCommerce website</title>
		<link rel="stylesheet" type="text/css" href="configurator.css">
	</head>
<body>
	
<!--THREE JS-->	
	<!--Librerie da importare-->
	<script src="lib/three.js"></script>
	<script src="lib/OrbitControls.js"></script>
	<script src="lib/stats.js"></script>
	<script src="lib/OBJLoader.js"></script>
	<script src="lib/dat.gui.min.js"></script>
	
	<!--Vertex Shader-->
	<script type="text/x-glsl" id="vertex">
		varying vec3 vNormal;
		varying vec3 vPosition;
		varying vec2 uVv;

		void main() {
			vec4 vPos = modelViewMatrix * vec4( position, 1.0 );
			vPosition = vPos.xyz;
			vNormal = normalMatrix * normal;
			uVv = uv;
			gl_Position = projectionMatrix * vPos;
		}
	</script>

	<!--Fragment Shader-->
	<script type="text/x-glsl" id="specular-diffuse-fragment">
		varying vec3 vNormal;
		varying vec3 vPosition;
		varying vec2 uVv;
		uniform vec3 pointLightPosition; // in world space
		uniform vec3 clight;
		uniform sampler2D specularMap;
		uniform sampler2D diffuseMap;
		uniform sampler2D roughnessMap;
		uniform vec2 textureRepeat;
		const float PI = 3.14159;

		vec3 cdiff;
		vec3 cspec;
		float roughness;
			
		vec3 FSchlick(float lDoth) {
			return (cspec + (vec3(1.0)-cspec)*pow(1.0 - lDoth,5.0));
		}

		float DGGX(float nDoth, float alpha) {
			float alpha2 = alpha*alpha;
			float d = nDoth*nDoth*(alpha2 - 1.0) + 1.0;
			return (  alpha2 / ( PI * d * d));
		}
			
		float G1(float dotProduct, float k) {
			return (dotProduct / (dotProduct * (1.0 - k) + k));	
		}
			
		float GSmith(float nDotv, float nDotl) {
			float k = roughness * roughness;
			return G1(nDotl,k)*G1(nDotv,k);
		}

		void main() {
			vec4 lPosition = viewMatrix * vec4( pointLightPosition, 1.0 );
			vec3 l = normalize(lPosition.xyz - vPosition.xyz);
			vec3 n = normalize( vNormal );
			vec3 v = normalize( -vPosition);
			vec3 h = normalize( v + l);

			// small quantity to prevent divisions by 0
			float nDotl = max(dot( n, l ),0.000001);
			float lDoth = max(dot( l, h ),0.000001);
			float nDoth = max(dot( n, h ),0.000001);
			float vDoth = max(dot( v, h ),0.000001);
			float nDotv = max(dot( n, v ),0.000001);

			cdiff = texture2D(diffuseMap, uVv * textureRepeat).rgb;
			cdiff = pow( cdiff, vec3(2.2));
			cspec = texture2D( specularMap, uVv * textureRepeat).rgb;
			cspec = pow( cspec, vec3(2.2));
			roughness = texture2D(roughnessMap, uVv * textureRepeat).r;

			vec3 fresnel = FSchlick(lDoth);

			vec3 BRDF = (vec3(1.0) - fresnel) * cdiff/PI + fresnel * GSmith(nDotv,nDotl) * DGGX(nDoth, roughness * roughness)/
					(4.0 * nDotl * nDotv);

			vec3 outRadiance = PI * clight * nDotl * BRDF;
			
			// gamma encode the final value
			gl_FragColor = vec4(pow( outRadiance, vec3(1.0/2.2)), 1.0);
			}
		</script>

	<!--Fragment Shader-->
	<script type="text/x-glsl" id="fragment-for-base">
		varying vec3 vNormal;
		varying vec3 vPosition;
		varying vec2 uVv;
		uniform vec3 pointLightPosition; // in world space
		uniform vec3 clight;
		uniform sampler2D specularMapBase;
		uniform sampler2D diffuseMapBase;
		uniform sampler2D roughnessMapBase;
		uniform vec2 textureRepeatBase;
		const float PI = 3.14159;

		vec3 cdiff;
		vec3 cspec;
		float roughness;
			
		vec3 FSchlick(float lDoth) {
			return (cspec + (vec3(1.0)-cspec)*pow(1.0 - lDoth,5.0));
		}

		float DGGX(float nDoth, float alpha) {
			float alpha2 = alpha*alpha;
			float d = nDoth*nDoth*(alpha2 - 1.0) + 1.0;
			return (  alpha2 / ( PI * d * d));
		}
			
		float G1(float dotProduct, float k) {
			return (dotProduct / (dotProduct * (1.0 - k) + k));	
		}
			
		float GSmith(float nDotv, float nDotl) {
			float k = roughness * roughness;
			return G1(nDotl,k)*G1(nDotv,k);
		}

		void main() {
			vec4 lPosition = viewMatrix * vec4( pointLightPosition, 1.0 );
			vec3 l = normalize(lPosition.xyz - vPosition.xyz);
			vec3 n = normalize( vNormal );
			vec3 v = normalize( -vPosition);
			vec3 h = normalize( v + l);

			// small quantity to prevent divisions by 0
			float nDotl = max(dot( n, l ),0.000001);
			float lDoth = max(dot( l, h ),0.000001);
			float nDoth = max(dot( n, h ),0.000001);
			float vDoth = max(dot( v, h ),0.000001);
			float nDotv = max(dot( n, v ),0.000001);

			cdiff = texture2D(diffuseMapBase, uVv * textureRepeatBase).rgb;
			cdiff = pow( cdiff, vec3(2.2));
			cspec = texture2D( specularMapBase, uVv * textureRepeatBase).rgb;
			cspec = pow( cspec, vec3(2.2));
			roughness = texture2D(roughnessMapBase, uVv * textureRepeatBase).r;

			vec3 fresnel = FSchlick(lDoth);

			vec3 BRDF = (vec3(1.0) - fresnel) * cdiff/PI + fresnel * GSmith(nDotv,nDotl) * DGGX(nDoth, roughness * roughness)/
					(4.0 * nDotl * nDotv);

			vec3 outRadiance = PI * clight * nDotl * BRDF;
			
			// gamma encode the final value
			gl_FragColor = vec4(pow( outRadiance, vec3(1.0/2.2)), 1.0);
			}
		</script>


	<!--Threejs code-->
	<div id="threejs">
	<script>
		
		var renderer = new THREE.WebGLRenderer({antialias: true});
		var camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 1, 1000);
		var controls = new THREE.OrbitControls( camera, renderer.domElement); //Controlli sulla camera
		var scene = new THREE.Scene();
		camera.position.set(0,100,200);

		//Luce puntiforme bianca
		var lightParameters = {
			red: 1.0,
			green: 1.0,
			blue: 1.0,
			intensity: 1.0
		}
		
		var textureParameters = {
			material: "Wood",
			repeatS: 1.0,
			repeatT: 1.0
		}
		
		
		var diffuseMap = loadTexture("texture/" + textureParameters.material + "_Base_Color.png");
		var specularMap = loadTexture("texture/" + textureParameters.material + "_Specular.png");
		var roughnessMap = loadTexture("texture/" + textureParameters.material + "_Roughness.png");

		//Passo gli uniforms agli shader
		var uniforms = {
			specularMapBase: { type: "t", value: specularMapBase },
			diffuseMapBase: { type: "t", value: diffuseMapBase },
			roughnessMapBase: { type: "t", value: roughnessMapBase },
			specularMap: { type: "t", value: specularMap },
			diffuseMap: { type: "t", value: diffuseMap },
			roughnessMap: { type: "t", value: roughnessMap },
			pointLightPosition: { type: "v3", value: new THREE.Vector3() },
			clight: { type: "v3", value: new THREE.Vector3() },
			textureRepeat: { type: "v2", value: new THREE.Vector2(0.1,0.1) },
			textureRepeatBase:{ type: "v2", value: new THREE.Vector2(0.01,0.01) }	
		};
		
		//Assi cartesiani
		var axesHelper = new THREE.AxesHelper( 1000);
		scene.add( axesHelper );
		
		//Carico gli shader
		vs = document.getElementById("vertex").textContent;
		specularDiffuseFragment = document.getElementById("specular-diffuse-fragment").textContent;
		fragmentForBase = document.getElementById("fragment-for-base").textContent;
		
		//Materiale da shader
		var myMaterial = new THREE.ShaderMaterial({uniforms: uniforms, vertexShader: vs, fragmentShader: specularDiffuseFragment});
		
		//Caricatore lampada
		var loaderLamp = new THREE.OBJLoader();
		//Carico il modello da source
		loaderLamp.load(
			'model/pixar_lamp.obj',
			function ( group ) {
				for(var i = 1; i < group.children.length; i++){
					geometry = group.children[i].geometry;
					mesh = new THREE.Mesh( geometry, myMaterial );
					scene.add( mesh );
				}
		});
		
		//Caricatore base
		var loaderBase = new THREE.OBJLoader();
		var diffuseMapBase = loadTexture("texture/Bamboo_Base_Color.png");
		var specularMapBase = loadTexture("texture/Bamboo_Specular.png");
		var roughnessMapBase = loadTexture("texture/Bamboo_Roughness.png");
		//Carico il modello da source
		loaderBase.load(
			'model/pixar_lamp.obj',
			function ( group ) {
					geometry = group.children[4].geometry;
					var baseMaterial = new THREE.ShaderMaterial({uniforms: uniforms, vertexShader: vs, fragmentShader: fragmentForBase});
					mesh = new THREE.Mesh( geometry, baseMaterial );
					scene.add( mesh );
				
		});
		
		//Caricatore lampadina
		var loaderBulb = new THREE.OBJLoader();
		var path = "texture/Wood_";
				var format = '.png';
				var urls = [
						path + 'Diffuse' + format, path + 'Diffuse' + format,
						path + 'Diffuse' + format, path + 'Diffuse' + format,
						path + 'Diffuse' + format, path + 'Diffuse' + format
					];
		var reflectionCube = new THREE.CubeTextureLoader().load( urls );
		reflectionCube.format = THREE.RGBFormat;
		//Carico la lampadina
		loaderBulb.load(
			'model/pixar_lamp.obj',
			function ( group ) {
				geometry = group.children[0].geometry;
				var lightMaterial = new THREE.MeshLambertMaterial({color: 0xffffff,
       																envMap: reflectionCube,
       																opacity: 0.5,
       																transparent: true});
				bulb = new THREE.Mesh(geometry, lightMaterial);
				scene.add(bulb);
			}
		)
		

	
		//Luce puntiforme
		var lightMesh = new THREE.Mesh(new THREE.SphereGeometry(16,16,16), new THREE.MeshBasicMaterial({color: 0xffff00, wireframe: true}));
		lightMesh.position.set(200, 400, 200);
		uniforms.pointLightPosition.value = new THREE.Vector3(lightMesh.position.x, lightMesh.position.y, lightMesh.position.z);
		
		//Interfaccia per modifiche runtime
		var gui;
		//Statistiche sul frame rate
		var stats = new Stats();
		
		//Carico texture
		function loadTexture(file) {
			var texture = new THREE.TextureLoader().load( file, function (texture) {
				
				texture.minFilter = THREE.LinearMipMapLinearFilter;
				texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
				texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
				texture.offset.set(0,0);
				texture.needsUpdate = true;
				render();
			})
			return texture;
		}

		function init() {
			
			renderer.setClearColor( 0xf0f0f0 );
			
			scene.add(camera);
			scene.add(lightMesh);
			
			document.body.appendChild(renderer.domElement);
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			
			controls.addEventListener('change', render);
			controls.update();
			
			window.addEventListener('resize', onResize, false);
			
			//Statistiche sul Frame Rate
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild(stats.domElement);
			
		}
		
		function onResize() {
			
			renderer.setSize(window.innerWidth, window.innerHeight);
			camera.aspect = (window.innerWidth / window.innerHeight);
			camera.updateProjectionMatrix();
		}
		
		function update() {
			requestAnimationFrame( update );
			stats.update();
		}


		function render() {
			updateUniforms();
			renderer.render(scene, camera);

			//Debugging
			console.log();

		}
		
		function clearGui() {
			
			if ( gui ) gui.destroy();
			gui = new dat.GUI();
			gui.open();
		}
		
		function buildGui() {
			clearGui();
			lightSettings = gui.addFolder('Light Parameters');
			lightSettings.add(lightParameters,'red').min(0).max(1).onChange( function(newVal) { render() });
			lightSettings.add(lightParameters,'green').min(0).max(1).onChange( function(newVal) { render() });
			lightSettings.add(lightParameters,'blue').min(0).max(1).onChange( function(newVal) { render() });
			lightSettings.add(lightParameters,'intensity').min(0).max(10000).onChange( function(newVal) { render() });
			textureSettings = gui.addFolder('Texture parameters');
			textureSettings.add(textureParameters,'material',[ 'Aluminum', 'Misc_SolarPanelLarge', 'Concrete_RockyFoundation',
			'Metal_ThickGrating' ]).onChange(
				function( newVal ) {
					diffuseMap = loadTexture( "textures/" + newVal + "_Diffuse.png" );
					specularMap = loadTexture( "textures/" + newVal + "_Specular.png" );
					roughnessMap = loadTexture( "textures/" + newVal + "_Roughness.png" );
					ourMaterial.needsUpdate = true;
				render()});
			textureSettings.add(textureParameters,'repeatS').min(0.1).max(10).onChange( function( newVal ) {render()});
			textureSettings.add(textureParameters,'repeatT').min(0.1).max(10).onChange( function( newVal ) {render()});
			}

		function updateUniforms() {
			uniforms.clight.value = new THREE.Vector3(lightParameters.red * lightParameters.intensity, lightParameters.green * lightParameters.intensity, lightParameters.blue * lightParameters.intensity);
			uniforms.textureRepeat.value = new THREE.Vector2( textureParameters.repeatS, textureParameters.repeatT);
			uniforms.diffuseMap.value = diffuseMap;
			uniforms.specularMap.value = specularMap;
			uniforms.roughnessMap.value = roughnessMap;
			uniforms.diffuseMapBase.value = diffuseMapBase;
			uniforms.specularMapBase.value = specularMapBase;
			uniforms.roughnessMapBase.value = roughnessMapBase;
			
		}

		
		
		
		init();
		buildGui();
		update();
		render();
		

    </script>
	</div>

		
<!--Web Site-->

	<!--header class="site-header">
		<h1 id="site-title"><span><a href="<?php echo esc_url( home_url( '/' ) ); ?>" title="<?php echo esc_attr( get_bloginfo( 'name', 'display' ) ); ?>" target="_top" rel="home">
			<img src="logo/ACME.jpg" alt="Acme Inc." width="500" height="95" class="logo" /></a></span></h1>
  		<nav>
    		<ul>
			  <li><a href="#" class="bounceInDown animated">Home</a></li>
			  <li><a href="#" class="bounceInDown animated">Chi siamo</a></li>
			  <li><a href="#" class="bounceInDown animated">News</a></li>
			  <li><a href="#" class="bounceInDown animated">Store</a></li>
			  <li><a href="#" class="bounceInDown animated">Contatti</a></li>
			</ul>
  		</nav>
	</header>
	<div class="contenitore">
  		<div class="card">
    		<div class="card-body">
      			<div class="descrizione-prodotto"> 
					<span class="prodotto"><b>Pixar Lamp</b><span class="badge">New</span></span>
					<span class="categoria"><b>Ufficio e studio</b></span> 
					<span class="info">L'originale Pixar Lamp. Illumina i tuoi sogni</span> 
				</div>
      			<div class="configuratore"> 
					<span class="quantita">
        				<h4>Quantità</h4>
						<ul class="ul-quantita">
						  <li><a href="#">1</a></li>
						  <li><a href="#">2</a></li>
						  <li><a href="#">4</a></li>
						</ul>
						</span> 
					<span class="materiali-prodotto"><h4>Materiale</h4>
						<ul class="ul-materiali">
						  <li><a href="#" class="plastic-orange animated pulse"></a></li>
						  <li><a href="#" class="midnight-black"></a></li>
						  <li><a href="#" class="original-aluminium"></a></li>
						</ul>
						</span> 
					<span class="prezzo"> € <b>29,98</b> </span> 
				</div>
    		</div>
  		</div>
	</div>-->

</body>
</html>
