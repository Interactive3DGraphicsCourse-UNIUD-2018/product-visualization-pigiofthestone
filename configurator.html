<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Welcome to ACME eCommerce website</title>
		<!--link rel="stylesheet" type="text/css" href="configurator.css"><link/-->
		
		<style>
			body {
				background-color: #f0f0f0;
				margin: 0px;
				overflow: hidden;
			}
			
			#info {
				position: absolute;
				top: 0px;
				width: 100%;
				color: #222;
				padding: 5px;
				font-family: Monospace;
				font-size: 13px;
				text-align: center;
			}
			
			a {
				color: #000;
				text-decoration: none;
			}
			a:hover {
				color: #0080ff;
			}
		</style>
	</head>
<body>
	
<!------------ THREE JS --------------->	
	<div id="info">
		<a href="configurator.html" target="_blank"> Website of ACME inc.</a>
	</div>
	
	<!--Librerie da importare-->
	<script src="lib/three.js"></script>
	<script src="lib/OrbitControls.js"></script>
	<script src="lib/stats.js"></script>
	<script src="lib/OBJLoader.js"></script>
	<script src="lib/dat.gui.min.js"></script>
	
	<!---Vertex shader--->
	<script type="text/x-glsl" id="vertex">
		varying vec3 vNormal;
		varying vec3 vPosition;
		
		void main() {
			vec4 vPos = modelViewMatrix * vec4(position, 1.0);
			vPosition = vPos.xyz;
			vNormal = normalMatrix * normal;
			gl_Position = projectionMatrix * vPos;
		}
	</script>
	
	<!---Fragment shader--->
	<script type="text/x-glsl" id="fragment">
		varying vec3 vNormal;
		varying vec3 vPosition;
		uniform vec3 pointLightPosition;
		uniform vec3 clight;
		uniform vec3 cspec;
		uniform vec3 cdiff;
		uniform float roughness;
		const float PI = 3.14159;
		
		vec3 FSchlick(float lDoth) { //Approssimazione di Shlick
			return (cspec + (vec3(1.0)-cspec)*pow(1.0 - lDoth,5.0)); 
		}
		
		float DGGX(float nDoth, float alpha) { //GGX/Trowbridge-Reitz
			float alpha2 = alpha*alpha;
			float d = nDoth*nDoth*(alpha2-1.0)+1.0;
			return (alpha2 / (PI*d*d));
		}
		
		float G1(float dotProduct, float k) { //Funzione per la funzione approssimata di Smith
			return (dotProduct / (dotProduct*(1.0-k) + k));
		}
		
		float GSmith(float nDotv, float nDotl) { //Funzione approssimata di Smith
			float k = roughness*roughness;
			return G1(nDotl, k)*G1(nDotv, k);
		}
		
		void main() {
			vec4 lPosition = viewMatrix * vec4(pointLightPosition, 1.0);
			vec3 l = normalize(lPosition.xyz - vPosition.xyz);
			vec3 n = normalize(vNormal);
			vec3 v = normalize(-vPosition);
			vec3 h = normalize(v + 1.0);
			
			//Quantità piccolissime per evitare la divisione per 0
			float nDotl = max(dot(n, l), 0.000001);
			float lDoth = max(dot(l, h), 0.000001);
			float nDoth = max(dot(n, h), 0.000001);
			float vDoth = max(dot(v, h), 0.000001);
			float nDotv = max(dot(n, v), 0.000001);
			
			vec3 fresnel = FSchlick(lDoth); //Funzione per la riflettanza di Fresnel
			
			//Calcolo dell'illuminazione con BRDF
			vec3 BRDF = (vec3(1.0)-fresnel)*cdiff/PI + fresnel*GSmith(nDotv,nDotl)*DGGX(nDoth,roughness*roughness)/(4.0*nDotl*nDotv);
			
			vec3 outRadiance = PI * clight * nDotl * BRDF;
			
			//Gamma encoding del valore finale
			gl_FragColor = vec4(pow(outRadiance, vec3(1.0/2.2)), 1.0);
		}
	</script>
	
	
	<script>
		
		var renderer = new THREE.WebGLRenderer({antialias: true});
		var camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 1000);
		var controls = new THREE.OrbitControls( camera, renderer.domElement); //Controlli sulla camera
		var scene = new THREE.Scene();

		//Luce puntiforme bianca
		var lightParameters = {
			red: 1.0,
			green: 1.0,
			blue: 1.0,
			intensity: 1.0,
		}

		var materialParameters = {
			
			cdiff_red: 1.0,
			cdiff_green: 1.0,
			cdiff_blue: 1.0,
			
			cspec_red: 0.04,
			cspec_green: 0.04,
			cspec_blue: 0.04,
			
			roughness: 0.3
		}

		//Passo gli uniforms agli shader
		var uniforms = {
			cspec: {type: "v3", value: new THREE.Vector3() },
			cdiff: {type: "v3", value: new THREE.Vector3() },
			roughness: {type: "f", value: 0.5 },
			pointLightPosition: {type: "v3", value: new THREE.Vector3()},
			clight: {type: "v3", value: new THREE.Vector3()},
		};

		//Carico gli shader
		vs = document.getElementById("vertex").textContent;
		fs = document.getElementById("fragment").textContent;

		//Caricatore modello
		var loader = new THREE.OBJLoader();

		//Carico il modello da source
		loader.load(
			'model/pixar_lamp.obj',
			function (object){
				var myMaterial = new THREE.ShaderMaterial({uniforms: uniforms, vertexShader: vs, fragmentShader: fs});
				object.traverse(function(child) {
								if (child instanceof THREE.Mesh) {
									child.material = myMaterial;
								}
							}),
				scene.add(object);
		});
				 
		
	
		

		//Luce puntiforme
		var lightMesh = new THREE.Mesh(new THREE.SphereGeometry(1,16,16), new THREE.MeshBasicMaterial({color: 0xffff00, wireframe: true}));
		lightMesh.position.set(200, 200, 200);
		uniforms.pointLightPosition.value = new THREE.Vector3(lightMesh.position.x, lightMesh.position.y, lightMesh.position.z);

		
		//Interfaccia per modifiche runtime
		var gui;
		//Statistiche sul frame rate
		var stats = new Stats();
		

		function init() {
			
			renderer.gammaInput = true;
			renderer.gammaOutput = true;
			renderer.setClearColor( 0xf0f0f0 );
			
			camera.position.set(-240, 120, 260);
			scene.add(camera);
			
			
			scene.add(lightMesh);
			
			document.body.appendChild(renderer.domElement);
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			
			controls.addEventListener('change', render);
			controls.update();
			
			window.addEventListener('resize', onResize, false);
			
			//Statistiche sul Frame Rate
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild(stats.domElement);
			
		}
		
		function onResize() {
			
			renderer.setSize(window.innerWidth, window.innerHeight);
			camera.aspect = (window.innerWidth, window.innerHeight);
			camera.updateProjectionMatrix();
		}
		
		function update() {
			requestAnimationFrame( update );
			stats.update();
		}


		function render() {
			updateUniforms();
			renderer.render(scene, camera);

			//Debugging
			console.log();

		}
		
		function clearGui() {
			
			if ( gui ) gui.destroy();
			gui = new dat.GUI();
			gui.open();
		}
		
		
		function buildGui() {
				clearGui();
				lightSettings = gui.addFolder('Light Parameters');
				lightSettings.add(lightParameters,'red').min(0).max(1).onChange( function(newVal) { render() });
				lightSettings.add(lightParameters,'green').min(0).max(1).onChange( function(newVal) { render() });
				lightSettings.add(lightParameters,'blue').min(0).max(1).onChange( function(newVal) { render() });
				lightSettings.add(lightParameters,'intensity').min(0).max(10000).onChange( function(newVal) { render() });
				materialSettings = gui.addFolder('material settings');
				materialSettings.add(materialParameters,'cdiff_red').min(0).max(1).onChange( function(newVal) { render() });
				materialSettings.add(materialParameters,'cdiff_green').min(0).max(1).onChange( function(newVal) { render() });
				materialSettings.add(materialParameters,'cdiff_blue').min(0).max(1).onChange( function(newVal) { render() });
				materialSettings.add(materialParameters,'cspec_red').min(0).max(1).onChange( function(newVal) { render() });
				materialSettings.add(materialParameters,'cspec_green').min(0).max(1).onChange( function(newVal) { render() });
				materialSettings.add(materialParameters,'cspec_blue').min(0).max(1).onChange( function(newVal) { render() });
				materialSettings.add(materialParameters,'roughness').min(0).max(1).onChange( function(newVal) { render() });
			}
		
		
		function updateUniforms() {
			uniforms.cspec.value = new THREE.Vector3(materialParameters.cspec_red, 	materialParameters.cspec_green, materialParameters.cspec_blue);
			
			uniforms.cdiff.value = new THREE.Vector3(materialParameters.cdiff_red,
									materialParameters.cdiff_green,materialParameters.cdiff_blue);
			
			uniforms.roughness.value = materialParameters.roughness>0.0?materialParameters.roughness:0.01;
			
			uniforms.clight.value = new THREE.Vector3(lightParameters.red * lightParameters.intensity,lightParameters.green * lightParameters.intensity,lightParameters.blue * lightParameters.intensity);
			
			
		}
		
		
		init();
		buildGui();
		update();
		render();
		

    </script>
		
<!--------------------------------------- SITO WEB -----------------------------------------
	<header>
  		<nav>
    		<ul>
			  <li><a href="#" class="bounceInDown animated">Home</a></li>
			  <li><a href="#" class="bounceInDown animated">Chi siamo</a></li>
			  <li><a href="#" class="bounceInDown animated">News</a></li>
			  <li><a href="#" class="bounceInDown animated">Store</a></li>
			  <li><a href="#" class="bounceInDown animated">Contatti</a></li>
			</ul>
  		</nav>
	</header>
	<div class="contenitore">
  		<div class="card">
    		<div class="card-body">
      			<div class="descrizione-prodotto"> 
					<span class="prodotto"><b>Pixar Lamp</b> <span class="badge pulse animated-infinite">New</span></span>
					<span class="categoria"><b>Ufficio e studio</b></span> 
					<span class="info">L'originale Pixar Lamp. Illumina i tuoi sogni</span> 
				</div>
      			<div class="configuratore"> 
					<span class="quantita">
        				<h4>Amount</h4>
						<ul class="ul-quantita">
						  <li><a href="#">1</a></li>
						  <li><a href="#">2</a></li>
						  <li><a href="#">4</a></li>
						</ul>
						</span> 
					<span class="materiali-prodotto"><h4>Color</h4>
						<ul class="ul-materiali">
						  <li><a href="#" class="plastic-orange animated pulse"></a></li>
						  <li><a href="#" class="midnight-black"></a></li>
						  <li><a href="#" class="original-aluminium"></a></li>
						</ul>
						</span> 
					<span class="prezzo"> € <b>29,98</b> </span> 
				</div>
    		</div>
  		</div>
	</div>
-->


	</body>
</html>
